# CorrecciÃ³n: Mapeo de IDs a Entidades en CreaciÃ³n de Notas

**Fecha:** 21 de enero de 2026  
**VersiÃ³n:** 2.6.0  
**Estado:** âœ… IMPLEMENTADO

---

## ğŸ› Problema Identificado

Al intentar crear notas desde el frontend, se generaba un `NullPointerException` con el siguiente error:

```
Cannot invoke "com.cesde.studentinfo.model.SubjectEnrollment.getId()" 
because the return value of "com.cesde.studentinfo.model.Grade.getSubjectEnrollment()" is null
```

### Causa RaÃ­z

El `GradeController.createGrade()` recibÃ­a correctamente el DTO con los IDs necesarios:
- `subjectEnrollmentId`
- `gradePeriodId`
- `gradeComponentId`
- `gradeValue`

**PERO** no los mapeaba a las entidades JPA correspondientes, construyendo un objeto `Grade` con relaciones `null`, lo que violaba las restricciones `NOT NULL` de la base de datos.

---

## âœ… SoluciÃ³n Implementada

### 1. Nuevos Repositorios Creados

Se crearon dos repositorios que faltaban para gestionar las entidades relacionadas:

#### **GradePeriodRepository.java**
```java
package com.cesde.studentinfo.repository;

import com.cesde.studentinfo.model.GradePeriod;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import java.util.Optional;

@Repository
public interface GradePeriodRepository extends JpaRepository<GradePeriod, Long> {
    Optional<GradePeriod> findByPeriodNumber(Integer periodNumber);
    Optional<GradePeriod> findByName(String name);
}
```

#### **GradeComponentRepository.java**
```java
package com.cesde.studentinfo.repository;

import com.cesde.studentinfo.model.GradeComponent;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import java.util.Optional;

@Repository
public interface GradeComponentRepository extends JpaRepository<GradeComponent, Long> {
    Optional<GradeComponent> findByCode(String code);
    Optional<GradeComponent> findByName(String name);
}
```

---

### 2. ModificaciÃ³n en GradeController

#### Cambios en las Importaciones y Campos
```java
// AGREGADO: Nuevos imports
import com.cesde.studentinfo.model.GradeComponent;
import com.cesde.studentinfo.model.GradePeriod;
import com.cesde.studentinfo.model.SubjectEnrollment;
import com.cesde.studentinfo.repository.GradeComponentRepository;
import com.cesde.studentinfo.repository.GradePeriodRepository;
import com.cesde.studentinfo.repository.SubjectEnrollmentRepository;

@RestController
@RequestMapping("/grades")
@RequiredArgsConstructor
@Slf4j
public class GradeController {
    
    private final GradeService gradeService;
    // AGREGADO: InyecciÃ³n de repositorios necesarios
    private final SubjectEnrollmentRepository subjectEnrollmentRepository;
    private final GradePeriodRepository gradePeriodRepository;
    private final GradeComponentRepository gradeComponentRepository;
```

#### Cambios en el MÃ©todo `createGrade()`

**ANTES (âŒ Incorrecto):**
```java
@PostMapping
public ResponseEntity<ApiResponse<GradeResponseDTO>> createGrade(@Valid @RequestBody GradeDTO dto) {
    log.info("POST /grades - Creating new grade");
    
    // âŒ NO mapeaba los IDs a entidades
    Grade grade = Grade.builder()
            .gradeValue(dto.getGradeValue())
            .assignmentDate(dto.getAssignmentDate())
            .comments(dto.getComments())
            .build(); // subjectEnrollment, gradePeriod, gradeComponent = NULL
    
    Grade saved = gradeService.createGrade(grade);
    return ResponseEntity.status(HttpStatus.CREATED)
            .body(ApiResponse.success(GradeResponseDTO.fromEntity(saved), "Grade created successfully"));
}
```

**DESPUÃ‰S (âœ… Correcto):**
```java
@PostMapping
public ResponseEntity<ApiResponse<GradeResponseDTO>> createGrade(@Valid @RequestBody GradeDTO dto) {
    log.info("POST /grades - Creating new grade for subject enrollment: {}", dto.getSubjectEnrollmentId());

    // âœ… Buscar las entidades relacionadas usando los IDs del DTO
    SubjectEnrollment subjectEnrollment = subjectEnrollmentRepository.findById(dto.getSubjectEnrollmentId())
            .orElseThrow(() -> new ResourceNotFoundException("SubjectEnrollment", dto.getSubjectEnrollmentId()));
    
    GradePeriod gradePeriod = gradePeriodRepository.findById(dto.getGradePeriodId())
            .orElseThrow(() -> new ResourceNotFoundException("GradePeriod", dto.getGradePeriodId()));
    
    GradeComponent gradeComponent = gradeComponentRepository.findById(dto.getGradeComponentId())
            .orElseThrow(() -> new ResourceNotFoundException("GradeComponent", dto.getGradeComponentId()));

    // âœ… Construir la entidad Grade con las relaciones correctas
    Grade grade = Grade.builder()
            .subjectEnrollment(subjectEnrollment)
            .gradePeriod(gradePeriod)
            .gradeComponent(gradeComponent)
            .gradeValue(dto.getGradeValue())
            .assignmentDate(dto.getAssignmentDate())
            .comments(dto.getComments())
            .build();

    Grade saved = gradeService.createGrade(grade);
    return ResponseEntity.status(HttpStatus.CREATED)
            .body(ApiResponse.success(GradeResponseDTO.fromEntity(saved), "Grade created successfully"));
}
```

---

## ğŸ” Validaciones Implementadas

El nuevo cÃ³digo valida que todas las entidades relacionadas existan:

1. **SubjectEnrollment** debe existir con el ID proporcionado
2. **GradePeriod** debe existir con el ID proporcionado
3. **GradeComponent** debe existir con el ID proporcionado

Si alguna entidad no existe, se lanza una `ResourceNotFoundException` con un mensaje claro indicando quÃ© entidad y quÃ© ID no se encontrÃ³.

---

## ğŸ“Š Flujo de Datos Correcto

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FRONTEND      â”‚
â”‚  EnvÃ­a GradeDTO â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ POST /grades
         â”‚ {
         â”‚   "subjectEnrollmentId": 1,
         â”‚   "gradePeriodId": 2,
         â”‚   "gradeComponentId": 3,
         â”‚   "gradeValue": 4.5
         â”‚ }
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   GradeController.createGrade() â”‚
â”‚                                 â”‚
â”‚  1. Busca SubjectEnrollment(1)  â”‚â”€â”€â–º Repository
â”‚  2. Busca GradePeriod(2)        â”‚â”€â”€â–º Repository
â”‚  3. Busca GradeComponent(3)     â”‚â”€â”€â–º Repository
â”‚                                 â”‚
â”‚  4. Construye Grade con         â”‚
â”‚     relaciones completas        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   GradeService.createGrade()    â”‚
â”‚                                 â”‚
â”‚  - Valida rango de nota (0-5)   â”‚
â”‚  - Establece fecha si es null   â”‚
â”‚  - Guarda en base de datos      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Base de Datos                 â”‚
â”‚                                 â”‚
â”‚  INSERT INTO grades (           â”‚
â”‚    subject_enrollment_id,       â”‚ âœ… NO NULL
â”‚    grade_period_id,             â”‚ âœ… NO NULL
â”‚    grade_component_id,          â”‚ âœ… NO NULL
â”‚    grade_value,                 â”‚
â”‚    assignment_date              â”‚
â”‚  ) VALUES (...)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§ª Testing

### Probar la SoluciÃ³n

**1. Reiniciar la API:**
```bash
cd /home/soporte/Desarrollos/idea/2026/back-bd-API
./start-api.sh
```

**2. Crear una nota desde Postman o Frontend:**
```bash
POST http://localhost:8080/grades
Authorization: Bearer {token}
Content-Type: application/json

{
  "subjectEnrollmentId": 1,
  "gradePeriodId": 1,
  "gradeComponentId": 1,
  "gradeValue": 4.5,
  "assignmentDate": "2026-01-21",
  "comments": "Excelente trabajo"
}
```

**Respuesta Esperada (200 OK):**
```json
{
  "success": true,
  "message": "Grade created successfully",
  "data": {
    "id": 1,
    "subjectEnrollmentId": 1,
    "gradePeriodId": 1,
    "gradeComponentId": 1,
    "gradeValue": 4.50,
    "assignmentDate": "2026-01-21",
    "comments": "Excelente trabajo",
    "updateDate": "2026-01-21T10:54:00"
  }
}
```

---

## ğŸ“ Archivos Modificados

1. âœ… **Creado:** `src/main/java/com/cesde/studentinfo/repository/GradePeriodRepository.java`
2. âœ… **Creado:** `src/main/java/com/cesde/studentinfo/repository/GradeComponentRepository.java`
3. âœ… **Modificado:** `src/main/java/com/cesde/studentinfo/controller/GradeController.java`

---

## ğŸ¯ Resultado

- âœ… **Error corregido:** Ya no se genera `NullPointerException`
- âœ… **Mapeo correcto:** Los IDs del DTO se mapean correctamente a las entidades JPA
- âœ… **Validaciones:** Se valida la existencia de todas las entidades relacionadas
- âœ… **Mensajes claros:** Errores descriptivos cuando falta alguna entidad
- âœ… **CompilaciÃ³n exitosa:** `BUILD SUCCESS`

---

## ğŸš€ PrÃ³ximos Pasos para el Frontend

El frontend **NO necesita cambios**, solo debe continuar enviando el mismo DTO:

```typescript
const gradeData = {
  subjectEnrollmentId: number,  // âœ… ID de la inscripciÃ³n a la materia
  gradePeriodId: number,        // âœ… ID del perÃ­odo (1, 2, 3)
  gradeComponentId: number,     // âœ… ID del componente (Quiz, Taller, etc.)
  gradeValue: number,           // âœ… Valor de la nota (0.00 - 5.00)
  assignmentDate?: string,      // Opcional: fecha en formato YYYY-MM-DD
  comments?: string             // Opcional: comentarios del profesor
};
```

---

## ğŸ“Œ Notas Importantes

1. **Los tres IDs son obligatorios** (`@NotNull` en el DTO)
2. **El `gradeValue` debe estar entre 0.00 y 5.00**
3. **Si `assignmentDate` es null, se establece automÃ¡ticamente a la fecha actual**
4. **Los comentarios son opcionales**

---

**Documentado por:** Sistema de GestiÃ³n AcadÃ©mica  
**RevisiÃ³n:** v2.6.0
